name: Go

on:
  # Allow manually triggering this workflow
  workflow_dispatch:
  # run for all pull requests and pushes to certain branches
  pull_request:
  push:
    branches:
      - main

jobs:
  build:
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
          - [self-hosted, linux-arm64]
    runs-on: ${{ matrix.os }}
    outputs:
      go-version: ${{ steps.set-go-version.outputs.version }}
    steps:
    - uses: actions/checkout@v3
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        check-latest: true
        go-version-file: "go.mod"
    - name: Set go-version output
      id: set-go-version
      if: ${{ matrix.os == 'ubuntu-latest' }}
      run: |
        echo "version=`go version | { read _ _ v _; echo ${v#go}; }`" >> $GITHUB_OUTPUT
    - name: Build
      run: go build -v ./...
    - name: Test
      run: go test -v ./...

  build-on-arm-emu:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [armv6l, armv7l]
        include:
        - arch: armv6l
          cpu: arm1176
          base_image: raspios_lite:latest
          cpu_info: cpuinfo/raspberrypi_zero_w
        - arch: armv7l
          cpu: cortex-a7
          base_image: raspios_lite:latest
          cpu_info: cpuinfo/raspberrypi_3b
    needs: build
    steps:
    - uses: actions/checkout@v3
    - name: Set up qemu
      uses: pguyot/arm-runner-action@v2
      with:
        base_image: ${{ matrix.base_image }}
        cpu: ${{ matrix.cpu }}
        cpu_info: ${{ matrix.cpu_info }}
        image_additional_mb: 1024
        commands: |
          wget -q https://go.dev/dl/go${{ needs.build.outputs.go-version }}.linux-armv6l.tar.gz
          tar -xf go${{ needs.build.outputs.go-version }}.linux-armv6l.tar.gz
          sudo mv go /usr/local
          /usr/local/go/bin/go build -v ./...
          /usr/local/go/bin/go test -v ./...
